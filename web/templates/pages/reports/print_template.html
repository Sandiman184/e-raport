<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Raport - {{ student.name }}</title>
    <style>
        /* BASE & PRINT SETTINGS */
        @page {
            size: A4;
            margin: 10mm 15mm;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 11pt;
            margin: 0;
            padding: 0;
            line-height: 1.3;
            -webkit-print-color-adjust: exact;
        }

        /* SCREEN PREVIEW (Paper Simulation) */
        @media screen {
            body {
                background: #525659;
                padding: 30px;
                text-align: center;
                min-width: 250mm;
            }

            .page {
                background: white;
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 10mm 15mm;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                box-sizing: border-box;
                text-align: left;
                position: relative;
            }

            .no-print {
                width: 210mm;
                margin: 0 auto 15px auto;
            }
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none;
            }

            .page {
                width: 100%;
                margin: 0;
                box-shadow: none;
                padding: 0;
            }

            body {
                background: white;
                padding: 0;
            }
        }

        /* UTILITY */
        .center {
            text-align: center;
        }

        .left {
            text-align: left;
        }

        .bold {
            font-weight: bold;
        }

        .uppercase {
            text-transform: uppercase;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        .main-table {
            margin-bottom: 15px;
        }

        .main-table th,
        .main-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            vertical-align: middle;
        }

        .main-table th {
            background-color: #e0e0e0;
            text-align: center;
            font-weight: bold;
            height: 35px;
        }

        /* LAYOUT COMPONENTS */
        .section-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 11pt;
        }

        .ttd-table {
            margin-top: 30px;
            border: none;
            width: 100%;
        }

        .ttd-table td {
            border: none;
            text-align: center;
            vertical-align: top;
        }

        /* KOP HEADER */
        .kop-container {
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 3px double #000;
            padding-bottom: 5px;
            margin-bottom: 20px;
            position: relative;
        }

        .kop-logo {
            position: absolute;
            left: 10px;
            width: 80px;
        }

        .kop-text {
            text-align: center;
            width: 100%;
        }

        .kop-text h2 {
            margin: 0;
            font-size: 16pt;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .kop-text p {
            margin: 0;
            font-size: 10pt;
        }
    </style>
</head>

<body>
    <div class="no-print" style="background:#ddd; padding:10px; text-align:center; border-radius: 4px;">
        <button onclick="window.print()"
            style="padding:10px 25px; background:teal; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">üñ®Ô∏è
            Cetak PDF</button>
        <br><small style="color:#555; margin-top:5px; display:inline-block;">*Tips: Gunakan Margin 'None' pada Setelan
            Printer</small>
    </div>

    <!-- Halaman Utama -->
    <div class="page">
        <!-- KOP SURAT (DYNAMIC) -->
        <div class="kop-container">
            <div class="kop-logo">
                <img src="{{ url_for('static', filename='img/logo.png') }}" style="width: 100%; height: auto;">
            </div>
            <div class="kop-text">
                <h2 class="uppercase">Madrasah Diniyah Takmiliyah</h2>
                <h2 class="uppercase">{{ get_setting('school_name', 'AL BAROKAH') }}</h2>
                <p class="bold">NSDT : {{ get_setting('school_nsdt', '411.2.32.06.0125') }}</p>
                <p>Alamat: {{ get_setting('school_address', 'Kp. Cikadu Desa Cikadu Kec. Cisayong Kab. Tasikmalaya') }}
                </p>
            </div>
        </div>

        <!-- JUDUL -->
        <div class="center bold uppercase" style="text-decoration: underline; margin-bottom: 20px; font-size: 12pt;">
            Laporan Hasil Belajar Santri
        </div>

        <!-- BIODATA (DYNAMIC) -->
        <table style="width: 100%; margin-bottom: 20px; font-weight: bold;" cellpadding="3">
            <tr>
                <td width="18%">Nama Santri</td>
                <td width="2%">:</td>
                <td width="40%" class="uppercase">{{ student.name }}</td>
                <td width="15%">Semester</td>
                <td width="2%">:</td>
                <td>{{ "Ganjil" if semester == 1 else "Genap" }}</td>
            </tr>
            <tr>
                <td>NISM</td>
                <td>:</td>
                <td>{{ student.nis }}</td>
                <td>Tahun Ajaran</td>
                <td>:</td>
                <td>{{ get_setting('academic_year', '2024 / 2025') }}</td>
            </tr>
            <tr>
                <td>Kelas</td>
                <td>:</td>
                <td>{{ get_setting('class_name_default', 'AWALIYAH 1') }}</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>

        <!-- A. NILAI AKADEMIK -->
        <div class="section-title">A. PENGETAHUAN</div>
        <table class="main-table">
            <thead>
                <tr>
                    <th rowspan="2" width="5%">NO</th>
                    <th rowspan="2" width="30%">MATA PELAJARAN</th>
                    <th rowspan="2" width="8%">KKM</th>
                    <th colspan="2">NILAI</th>
                    <th rowspan="2">DESKRIPSI KEMAJUAN BELAJAR</th>
                </tr>
                <tr>
                    <th width="10%">Angka</th>
                    <th width="15%">Huruf</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subjects %}
                {% set g = grades.get(sub.id) %}
                {% set val = g.nr|round(0)|int if g and g.nr else 0 %}
                <tr>
                    <td class="center">{{ loop.index }}</td>
                    <td class="left" style="padding-left: 8px;">{{ sub.name }}</td>
                    <td class="center">{{ sub.kkm|int }}</td>
                    <td class="center bold">{{ val if g and g.nr else '-' }}</td>
                    <td class="center" style="font-size: 10pt;">
                        {% if g and g.nr %}
                        {% if val >= 90 %}Sembilan Puluh
                        {% elif val >= 80 %}Delapan Puluh
                        {% elif val >= 70 %}Tujuh Puluh
                        {% elif val >= 60 %}Enam Puluh
                        {% else %}Lima Puluh{% endif %}
                        {% if val % 10 != 0 %} Lima {% endif %}
                        {% else %}-{% endif %}
                    </td>
                    <td style="font-size: 10pt; text-align: left; padding: 4px 8px;">
                        {% if g and g.nr %}
                        {% if val >= 90 %}
                        Alhamdulillah, ananda mampu menguasai materi dengan sangat baik.
                        {% elif val >= sub.kkm %}
                        Alhamdulillah, ananda mampu menguasai materi dengan baik.
                        {% else %}
                        Ananda perlu meningkatkan semangat belajar dan mengulang materi.
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- NON AKADEMIK -->
        <div class="section-title">B. PENGEMBANGAN DIRI</div>
        <table class="main-table">
            <thead>
                <tr>
                    <th width="5%">NO</th>
                    <th width="35%">JENIS KEGIATAN</th>
                    <th width="10%">NILAI</th>
                    <th>KETERANGAN</th>
                </tr>
            </thead>
            <tbody>
                {% set extras = record.extras %}
                {% if extras %}
                {% for item in extras %}
                <tr>
                    <td class="center">{{ loop.index }}</td>
                    <td>{{ item.name }}</td>
                    <td class="center">{{ item.grade }}</td>
                    <td>{{ item.desc }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="center">-</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <div class="section-title">C. AKHLAK DAN KEPRIBADIAN</div>
        <table class="main-table">
            <thead>
                <tr>
                    <th width="5%">NO</th>
                    <th width="35%">ASPEK PENILAIAN</th>
                    <th width="10%">NILAI</th>
                    <th>KETERANGAN</th>
                </tr>
            </thead>
            <tbody>
                {% set pers = record.personality %}
                {% if pers %}
                {% for item in pers %}
                <tr>
                    <td class="center">{{ loop.index }}</td>
                    <td>{{ item.aspect }}</td>
                    <td class="center">{{ item.grade }}</td>
                    <td>{{ item.desc }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="center">-</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 20px;">
            <!-- Kiri: Ketidakhadiran -->
            <div style="width: 45%;">
                <div class="section-title" style="margin-top:0;">D. KETIDAKHADIRAN</div>
                <table class="main-table">
                    <tr>
                        <td width="60%">1. Sakit</td>
                        <td class="center">{{ record.attendance_sakit }} hari</td>
                    </tr>
                    <tr>
                        <td>2. Izin</td>
                        <td class="center">{{ record.attendance_izin }} hari</td>
                    </tr>
                    <tr>
                        <td>3. Tanpa Keterangan</td>
                        <td class="center">{{ record.attendance_alpa }} hari</td>
                    </tr>
                    <tr>
                        <td class="bold" style="background:#eee;">JUMLAH</td>
                        <td class="center bold">{{ record.attendance_sakit + record.attendance_izin +
                            record.attendance_alpa }} hari</td>
                    </tr>
                </table>
            </div>

            <!-- Kanan: Catatan -->
            <div style="width: 50%;">
                <div class="section-title" style="margin-top:0;">E. CATATAN WALI KELAS</div>
                <div
                    style="border: 2px solid black; padding: 15px; height: 100px; font-style: italic; position: relative;">
                    "{{ record.notes if record.notes else '' }}"
                </div>
            </div>
        </div>

        <!-- TANDA TANGAN (DYNAMIC) -->
        <table class="ttd-table">
            <tr>
                <td width="30%">
                    Mengetahui,<br>Orang Tua / Wali
                    <br><br><br><br><br>
                    (.....................................)
                </td>
                <td width="30%">
                    Mengetahui,<br>Kepala Madrasah
                    <br><br><br><br><br>
                    <strong><u>{{ get_setting('headmaster_name', 'UST. SARIPUDIN, S.Pd.I') }}</u></strong>
                </td>
                <td width="40%">
                    {{ get_setting('report_place', 'Tasikmalaya') }}, {{ get_setting('report_date',
                    '...................... 2025') }}<br>
                    Wali Kelas
                    <br><br><br><br><br>
                    <strong><u>( .................................... )</u></strong>
                </td>
            </tr>
        </table>
    </div>
</body>

</html>